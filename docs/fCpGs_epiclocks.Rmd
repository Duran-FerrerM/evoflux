---
title: "fCpGs and other epigenetic clocks, Gabbutt and Duran-Ferrer 2025"
author:
  - name: "Martí Duran-Ferrer, 2025"
    affiliation: "Institut d'Investigacions Biomèdiques Augusti Pi i Sunyer (IDIBAPS), Barcelona, Spain."
    email: "maduran@recerca.clinic.cat"
date: "10/07/2025"
output: 
    BiocStyle::html_document:
      toc: true
      toc_float: true
      toc_depth: 4
      number_sections: true
      code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,results = FALSE,message=FALSE,warning=FALSE)
```

fCpG methylation represents a previously unrecognized type of CpG methylation and is different from any other reported epigenetic clock or cell-type specific CpG, repreenting neutral and cell lineage markers.

# Load packages and fCpG information

```{r}


library(data.table)
library(dplyr)
library(ComplexHeatmap)
library(methylCIPHER)
library(DunedinPACE)
library(pals)

options(stringsAsFactors = F,max.print = 10000,error=NULL,
        "openxlsx.dateFormat" = "dd/mm/yyyy"
        )

## fCpGs
fCpGs <- fread("../Data/FMC/Final_data/beta_all_samples_fcpgs_laplacian.csv",data.table = F)
rownames(fCpGs) <- fCpGs$V1
fCpGs <- fCpGs[,-1]
fCpGs[1:5,1:15]
head(fCpGs);dim(fCpGs)



```

# Load CpGs from epigenetic clocks

We next collect a huge number of CpGs that have been reported to be part of distinct calsses of "epigenetic clocks", measuring differnt biological aspects such as chronological age, mitotic age, trait predictors, etc.

## All clocks

```{r}


ht_opt$legend_grid_width <- unit(2,"mm")
ht_opt$legend_grid_height <-unit(2,"mm")
ht_opt$legend_labels_gp <- gpar(fontsize=5)
ht_opt$legend_title_gp <- gpar(fontsize=5)
ht_opt$heatmap_column_title_gp <- gpar(fontsize=5)
ht_opt$heatmap_row_title_gp <- gpar(fontsize=5)
ht_opt$heatmap_row_names_gp <- gpar(fontsize=5)
ht_opt$heatmap_column_names_gp <- gpar(fontsize=5)
ht_opt$HEATMAP_LEGEND_PADDING <- unit(1,"mm")
ht_opt$ANNOTATION_LEGEND_PADDING <- unit(1,"mm")
ht_opt$legend_gap <- unit(c(1,1),"mm")
ht_opt$fast_hclust <- T

# Load epiCMIT CpGs
# download.file("https://github.com/Duran-FerrerM/Pan-B-cell-methylome/raw/master/data/Estimate.epiCMIT.RData", destfile = "Estimate.epiCMIT.RData", method="libcurl")
load("../Scripts/2_Deconvolution_clocks/Estimate.epiCMIT.RData")


##
##  Load other clocks collected in methylCIPHER package
## 

clockOptions()
length(sort(gsub("calc","",sort(clockOptions()))))
length(sort(grep("_CpG",ls("package:methylCIPHER"),value = T)))

clockOptions()
clockOptions()[1:30]

levine.clocks <- structure(grep("_CpG",ls("package:methylCIPHER"),value = T),
                           names=grep("_CpG",ls("package:methylCIPHER"),value = T)
                           )

sort(names(levine.clocks))

levine.clocks <- lapply(levine.clocks, function(clock.i){
  writeLines(clock.i)
  get(clock.i)
})

lapply(levine.clocks,head)

levine.clocks.CpGs <- lapply(levine.clocks, function(dat.i){
  
  if(!is.null(dim(dat.i))){
    dat.i <- data.frame(dat.i)
    cpgs.col <- grep("Marker|ID|CpG",colnames(dat.i),ignore.case = T)
    if(length(cpgs.col)==1){
      cpgs <- dat.i[,cpgs.col]
    }else if(length(cpgs.col)>1){
      print(dat.i)
      stop("re-code script")
    }else{
      cpgs <- rownames(dat.i)
    }
    
  }else{
    cpgs <- dat.i
  }
  
  cpgs <- grep("^cg",cpgs,value = T)
  return(cpgs)
})

length(levine.clocks)
length(levine.clocks.CpGs)==length(levine.clocks)
sapply(levine.clocks.CpGs,length)


##add dunedin CpGs
levine.clocks.CpGs <- c(c(levine.clocks.CpGs,
                                list(DunedinPACE=as.character(unlist(DunedinPACE::getRequiredProbes())))
                                )
                           )
length(levine.clocks.CpGs)
names(levine.clocks.CpGs)


clocks <- c(list(fCpGs=rownames(fCpGs),
                 epiCMIT=epiCMIT.v2.Annot$epiCMIT.450K.EPIC.hg19$Name),
            levine.clocks.CpGs
            )
names(clocks) <- gsub("_CpGs|_CpG","",names(clocks))
names(clocks)

## filter some clocks and organize them by biological insights
clocks.filtered <- clocks[!names(clocks) %in% c("LeeRobust","LeeControl","HRSInCHPhenoAge","calcHRSInChPhenoAge")]
sort(names(clocks.filtered))
length(clocks.filtered)

clock.type <- list("fCpGs"="fCpGs",
                   "Chronological"=c("Bocklandt","Garagnani","Hannum","Horvath1","Lin","VidalBralo","Weidner","Zhang2019"),
                   "Mitotic"=c("epiCMIT","hypoClock","EpiToc","EpiToc2","MiAge"),
                   "Gestational and pediatric age"=c("Bohlin","Knight","LeeRefinedRobust","Mayne","PEDBE"),
                   "Biological age and mortality"=c("DNAmTL","PhenoAge","DunedinPACE","Zhang_10"),
                   "Trait predictors"=c("Alcohol","BMI","Smoking"),
                   "Age non-blood"=c("Horvath2","DNAmClockCortical")
                   )
clock.type <- unlist(clock.type)
names(clock.type) <- gsub("\\d+","",names(clock.type))

clock.type
# sort clocks accordingly
clocks.filtered <- clocks.filtered[clock.type]

data.frame(names(clocks.filtered),clock.type)

clocks.colors <- structure(pals::kelly(length(unique(names(clock.type)))),
                           names=unique(names(clock.type)))

m <- make_comb_mat(clocks.filtered)

draw(UpSet(m = m,
           comb_order = order(comb_size(m),decreasing = T),#order(comb_degree(m),decreasing = F),
           comb_col = rev(brewer.blues(n = length((table(comb_degree(m))))))[comb_degree(m)],
           set_order = order(set_size(m),decreasing = T),#clock.type,
           row_names_side = "left",
           # heatmap_legend_param = list(legend_direction="horizontal",
           #                             legend_width = unit(5, "cm")
           #                             ),
           left_annotation = HeatmapAnnotation(which = "row",
                                               # clock_names=anno_text(names(clocks.filtered)),
                                               clocks=names(clock.type),
                                               col=list(clocks=clocks.colors
                                                        )
                                               # annotation_legend_param = list(legend_direction="horizontal")
                                               ),
           top_annotation = upset_top_annotation(m = m,add_numbers = TRUE,annotation_name_rot = 90,numbers_rot=90),
           right_annotation = upset_right_annotation(m = m,add_numbers = TRUE),
           ),
     merge_legend=T,
     heatmap_legend_side = "bottom",
     # annotation_legend_side = "bottom"
     )


```

### Simplified clocks

```{r}

##
## SIMPLIFY PLOT
##



data.frame(clock.type,names(clock.type))

clocks.filtered.simplified <- list("fCpGs"=unique(unlist(clocks.filtered[clock.type[which(names(clock.type)=="fCpGs")]])),
                                "Mitotic"=unique(unlist(clocks.filtered[clock.type[which(names(clock.type)=="Mitotic")]])),
                                "Age"=unique(unlist(clocks.filtered[c(clock.type[which(names(clock.type)=="Chronological")],
                                                        clock.type[which(names(clock.type)=="Age non-blood")],
                                                        clock.type[which(names(clock.type)=="Gestational and pediatric age")]
                                                        )])),
                                "Biological age and mortality"=unique(unlist(clocks.filtered[clock.type[which(names(clock.type)=="Biological age and mortality")]])),
                                "Trait predictors"=unique(unlist(clocks.filtered[clock.type[which(names(clock.type)=="Trait predictors")]]))
                                )
str(clocks.filtered.simplified)
m <- make_comb_mat(clocks.filtered.simplified)


draw(UpSet(m = m,
           comb_order = order(comb_size(m),decreasing = T),#order(comb_degree(m),decreasing = F),
           # comb_col = rev(brewer.blues(n = length((table(comb_degree(m))))))[comb_degree(m)],
           set_order = order(set_size(m),decreasing = T),#clock.type,
           row_names_side = "left",
           # heatmap_legend_param = list(legend_direction="horizontal",
           #                             legend_width = unit(5, "cm")
           #                             ),
           # left_annotation = HeatmapAnnotation(which = "row",
           #                                     # clock_names=anno_text(names(clocks.filtered)),
           #                                     clocks=names(clock.type),
           #                                     col=list(clocks=clocks.colors
           #                                     )
           #                                     # annotation_legend_param = list(legend_direction="horizontal")
           # ),
           top_annotation = upset_top_annotation(m = m,add_numbers = TRUE,annotation_name_rot = 90,numbers_rot=90),
           right_annotation = upset_right_annotation(m = m,add_numbers = TRUE),
),
merge_legend=T,
heatmap_legend_side = "bottom",
# annotation_legend_side = "bottom"
)


```



# Session info
```{r, echo=TRUE,include=TRUE,results='markup'}
print(sessionInfo())

```
